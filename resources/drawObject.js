var paper;
var key = [
	{'code':['3'],'label':'Star','colour':colours.red[0], 'shape':'star' },
	{'code':['3.6','7.1.2'],'label':'Group of stars','colour':colours.orange[2], 'shape':'group' },
	{'code':['3.6.4.1'],'label':'Open cluster','colour':colours.rose[0], 'shape':'opencluster' },
	{'code':['3.6.4.2'],'label':'Globular cluster','colour':colours.rose[0], 'shape':'cluster' },
	{'code':['4'],'label':'Nebula','colour':colours.purple[2], 'shape':'nebula' },
	{'code':['4.1.4'],'label':'Supernova remnant','colour':colours.purple[0], 'shape':'supernova' },
	{'code':['5'],'label':'Galaxy','colour':colours.turquoise[2], 'shape':'galaxy' },
	{'code':['5.1.1'],'label':'Spiral galaxy','colour':colours.turquoise[0], 'shape':'spiral' },
	{'code':['5.1.2'],'label':'Barred galaxy','colour':colours.turquoise[0], 'shape':'barred' },
	{'code':['5.1.3'],'label':'Lenticular galaxy','colour':colours.blue[2], 'shape':'elliptical' },
	{'code':['5.1.4'],'label':'Elliptical galaxy','colour':colours.green[1], 'shape':'lenticular' },
	//{'code':['5.1.6'],'label':'Irregular galaxy','colour':colours.turquoise[0], 'shape':'circle' },
	{'code':['5.1.7'],'label':'Interacting galaxy','colour':colours.turquoise[0], 'shape':'interacting' },
	{'code':['7.2.1.1'],'label':'Total solar eclipse','colour':colours.purple[0], 'shape':'totaleclipse' },
	{'code':['7.2.1.2'],'label':'Partial solar eclipse','colour':colours.purple[0], 'shape':'partialeclipse' },
	{'code':['7.2.1.3'],'label':'Annular solar eclipse','colour':colours.purple[0], 'shape':'annulareclipse' },
	{'code':['7.2.1.4'],'label':'Hybrid solar eclipse','colour':colours.purple[0], 'shape':'hybrideclipse' },
	{'code':['7.2.1.5'],'label':'Annular solar eclipse (bg)','colour':'#e1f4fe', 'shape':'totaleclipse', 'nokey':true },
	{'code':['7.2.2.1'],'label':'Total lunar eclipse','colour':colours.blue[0], 'shape':'totaleclipse' },
	{'code':['7.2.2.2'],'label':'Partial lunar eclipse','colour':colours.blue[0], 'shape':'partialeclipse' },
	{'code':['7.2.2.3'],'label':'Penumbral lunar eclipse','colour':colours.blue[0], 'shape':'annulareclipse' },
	{'code':['7.2.2.4'],'label':'Penumbral lunar eclipse (bg)','colour':'#ffffff', 'shape':'totaleclipse','nokey':true },
	{'code':['0'],'label':'Lost / Doesn\'t exist','colour':colours.turquoise[4], 'shape':'none' }
];

function star(x1,y1,r,dR,points){

	if(isNaN(r)) return "";
	if(!points) points = 5;
	if(!dR || isNaN(dR)) dR = 0.5;
	var x,y,i,R;
	var path = "M"+x1.toFixed(3)+","+y1.toFixed(3);
	var d2r = (Math.PI/180);
	var da = d2r*360/(points*2);
	var aoff = da;
	var a = aoff;
	for(i = 0; i < (points*2); i++){
		a += da;
		R = (i % 2 ==0) ? r : r*dR;
		x = x1 + R*Math.cos(a);
		y = y1 + R*Math.sin(a);
		path += (i==0 ? "M":"L")+x.toFixed(3)+","+y.toFixed(3);
	}
	return path+"z";
}

function getType(avm){
	var prop = { 'colour': 'white', 'shape': 'square' };
	if(!avm) avm = "";

	for(var k = 0 ; k < key.length; k++){
		for(var c = 0; c < key[k].code.length; c++){
			if(avm.match("(^|;)"+key[k].code[c])) prop = key[k];
		}
	}
	return prop;
}


function getObjectPath(avm,x,y,s,pp,attr){

	if(typeof pp!=="object") pp = paper;

	var prop = getType(avm);
	var shape = "";
	var scale = 56.7/2;
	if(prop.shape=="star") shape = 'm -22.099 19.199 l 2.864 2.863 l 19.232 -19.229 l 19.231 19.229 l 2.863 -2.863 l -19.231 -19.229 l 19.231 -19.229 l -2.863 -2.863 l -19.231 19.229 l -19.232 -19.229 l -2.864 2.863 l 19.233 19.22896 z';
	if(prop.shape=="group") shape = 'm 22.952 1.993 l 0 -4.05 l -18.068 0 l 12.777 -12.777 l -2.863 -2.863 l -12.781 12.781 l 0 -18.072 l -4.05 0 l 0 18.064 l -12.773 -12.773 l -2.863 2.863 l 12.777 12.777 l -18.068 0 l 0 4.05 l 18.068 0 l -12.777 12.777 l 2.863 2.863 l 12.773 -12.773 l 0 18.068 l 4.05 0 l 0 -18.076 l 12.781 12.781 l 2.863 -2.863 l -12.777 -12.777 z';
	if(prop.shape=="opencluster") shape = "m 0 -22.988 l -22.957 22.958 l 22.957 22.958 l 22.957 -22.958 z m -17.231 22.958 l 17.231 -17.231 l 17.23 17.231 l -17.23 17.231 z";
	if(prop.shape=="cluster") shape = "m 0 -22.988 l -22.957 22.958 l 22.957 22.958 l 22.957 -22.958 z";
	if(prop.shape=="supernova") shape = "m 0 -22.999 c -12.679 0 -22.937 10.29 -22.936 22.96896 c 0 12.67904 10.257 22.96904 22.936 22.96904 c 12.679 0 22.965 -10.29 22.965 -22.96904 c 0 -12.679 -10.286 -22.968 -22.965 -22.969 z m 0 4.063 c 10.426 0 18.906 8.48 18.906 18.90596 c 0 10.42604 -8.48 18.90704 -18.906 18.90704 c -10.426 0 -18.905 -8.481 -18.905 -18.90704 c 0 -10.42596 8.479 -18.90596 18.905 -18.90596 z m -6.875 9.9999 c -0.518 0 -1.042 0.198 -1.438 0.594 c -0.791 0.79 -0.791 2.052 0 2.843 l 5.469 5.46906 l -5.469 5.43794 c -0.791 0.791 -0.791 2.085 0 2.875 c 0.397 0.396 0.916 0.593 1.438 0.594 c 0.522 0 1.042 -0.198 1.438 -0.594 l 5.437 -5.438 l 5.469 5.438 c 0.396 0.396 0.884 0.593 1.406 0.594 c 0.522 0 1.042 -0.198 1.438 -0.594 c 0.791 -0.79 0.791 -2.084 0 -2.875 l -5.438 -5.438 l 5.438 -5.469 c 0.791 -0.791 0.791 -2.053 0 -2.843 c -0.792 -0.791 -2.053 -0.791 -2.844 0 l -5.469 5.437 l -5.437 -5.437 c -0.396 -0.396 -0.92 -0.594 -1.438 -0.594 z";
	if(prop.shape=="nebula") shape = "m -1.192 -22.978 c -12.13 0.615 -21.782 10.656 -21.781 22.93896 c 0 12.67604 10.289 22.96604 22.968 22.96604 c 12.679 0 22.969 -10.29 22.969 -22.96604 c 0 -12.67896 -10.29 -22.93896 -22.969 -22.93896 c -0.396 0 -0.796 -0.02 -1.187 0 z m 1.187 4.033 c 10.426 0 18.906 8.48 18.906 18.90596 c 0 10.42604 -8.48 18.90604 -18.906 18.90604 c -10.426 0 -18.906 -8.48 -18.906 -18.90604 c 0 -10.42596 8.48 -18.90696 18.906 -18.90696 z m 0 7.437 c -6.339 0 -11.469 5.1289 -11.468 11.46896 c 0 6.33994 5.129 11.49604 11.468 11.49604 c 6.339 0 11.469 -5.1561 11.469 -11.49604 c 0 -6.34006 -5.13 -11.46896 -11.469 -11.46896 z m 0 4.0309 c 4.097 0 7.438 3.341 7.438 7.43806 c 0 4.09594 -3.341 7.43694 -7.438 7.43694 c -4.097 0 -7.437 -3.341 -7.437 -7.43694 c 0 -4.09706 3.34 -7.43806 7.437 -7.43806 z";
	if(prop.shape=="galaxy") shape = "m 22.958 0 c 0 12.679 -10.279 22.958 -22.958 22.958 c -12.679 0 -22.958 -10.279 -22.958 -22.958 c 0 -12.679 10.279 -22.958 22.958 -22.958 c 12.679 0 22.958 10.279 22.958 22.958 z";
	if(prop.shape=="spiral") shape = "m 12.932 -4.3461 c -1.178 -3.544 -3.48 -6.1929 -6.849 -7.8779 c -3.345 -1.669 -6.889 -1.922 -10.408 -0.743 c -3.539 1.179 -6.171 3.4709 -7.841 6.7939 l -4.284 -12.862 c -0.355 -1.06 -1.502 -1.621 -2.562 -1.281 c -1.06 0.356 -1.637 1.503 -1.281 2.563 l 7.333 22.0179 c 0 0 0 0.02 0.01 0.02 c 1.194 3.544 3.496 6.2011 6.849 7.8781 c 1.962 0.981 3.994 1.471 6.043 1.471 c 1.439 0 2.91 -0.245 4.365 -0.728 c 3.533 -1.18 6.167 -3.4731 7.845 -6.7981 l 4.288 12.868 c 0.285 0.84 1.076 1.38 1.922 1.38 c 0.214 0 0.427 0 0.641 -0.1 c 1.059 -0.36 1.637 -1.5 1.281 -2.56 l -7.352 -22.042 z m -4.373 8.605 c -1.195 2.388 -3.006 3.962 -5.537 4.809 c -2.507 0.846 -4.951 0.672 -7.316 -0.522 c -2.388 -1.195 -3.97 -3.014 -4.816 -5.537 c 0 0 0 0 0 0 c 0 0 0 0 0 0 l 0 0 c -0.833 -2.54294 -0.661 -4.927 0.532 -7.311 c 1.194 -2.388 2.997 -3.962 5.536 -4.809 c 1.044 -0.348 2.08 -0.522 3.085 -0.522 c 1.415 0 2.847 0.348 4.231 1.044 c 2.404 1.203 3.978 3.014 4.816 5.537 c 0.847 2.53106 0.673 4.927 -0.529 7.324 z";
	if(prop.shape=="barred") shape = 'm -0.006 -20.414 c -5.608 0 -10.483 2.014 -14.437 5.969 c -3.953 3.948 -5.937 8.7919 -5.937 14.40696 c 0 1.11604 0.885 2.03094 2.001 2.03094 c 1.113 0 2.029 -0.9149 2.029 -2.03094 c 0 -4.56306 1.571 -8.35206 4.782 -11.56296 c 3.211 -3.211 6.998 -4.75 11.562 -4.75 c 1.115 0 2.031 -0.916 2.032 -2.031 c 0 -1.115 -0.917 -2.032 -2.032 -2.032 z m -9.187 18.3449 c -1.115 0 -2.032 0.916 -2.031 2.03106 c 0 1.11604 0.916 2.03094 2.031 2.03094 l 18.343 0 c 1.116 0 2.032 -0.9149 2.032 -2.03094 c 0 -1.11506 -0.916 -2.03106 -2.032 -2.03106 l -18.343 0 z m 27.531 0 c -1.115 0 -2.031 0.908 -2.031 2.03106 c 0 4.56394 -1.577 8.35094 -4.781 11.56204 c -3.22 3.211 -6.96 4.781 -11.5 4.781 l -0.03 0 c -1.115 0 -2.031 0.877 -2.031 2 c 0 1.124 1.033 2.198 2.063 2.032 c 5.584 0 10.412 -1.984 14.375 -5.938 c 3.947 -3.955 5.96 -8.8291 5.968 -14.43704 c 0 -1.11506 -0.908 -2.03106 -2.031 -2.03106 z';
	if(prop.shape=="interacting") shape = 'm 9.23 -20.421 c -2.857 0 -5.688 1.099 -7.843 3.251 c -1.924 1.924 -2.881 4.289 -3.094 6.938 l -6.937 -6.938 c -0.792 -0.791 -2.084 -0.791 -2.876 0 c -0.791 0.791 -0.791 2.053 0 2.844 l 12.907 12.906 c 2.175 2.16706 4.822 3.25 7.875 3.25 c 3.053 0 5.7 -1.08294 7.875 -3.25 c 2.159 -2.167 3.25 -4.845 3.25 -7.906 c 0 -3.0519 -1.102 -5.6799 -3.25 -7.8439 c -2.171 -2.163 -5.049 -3.254 -7.907 -3.251 z m 0.03 4.032 c 1.977 0 3.608 0.679 5 2.063 c 1.384 1.392 2.062 3.054 2.062 5.0309 c 0 1.978 -0.678 3.608 -2.062 5 c -2.8 2.784 -7.231 2.784 -10.032 0 c -1.392 -1.4 -2.062 -3.022 -2.062 -5 c 0 -1.9769 0.67 -3.6389 2.062 -5.0309 c 1.393 -1.392 3.054 -2.063 5.032 -2.063 z m -18.5 14.4999 c -2.859 0 -5.743 1.05606 -7.906 3.219 c -2.16 2.151 -3.249 4.806 -3.249 7.875 c 0 3.0531 1.082 5.7001 3.249 7.8751 c 2.159 2.16 4.806 3.282 7.874 3.281 c 3.07 0 5.724 -1.121 7.876 -3.281 c 1.924 -1.924 2.88 -4.285 3.093 -6.937 l 6.938 6.937 c 0.395 0.396 0.923 0.594 1.437 0.594 c 0.522 0 1.042 -0.198 1.438 -0.594 c 0.791 -0.791 0.791 -2.052 0 -2.844 l -12.904 -12.906 c -2.148 -2.15494 -4.985 -3.217 -7.844 -3.219 z m -0.03 4.031 c 1.987 0 3.64 0.671 5.032 2.063 c 1.392 1.392 2.062 3.023 2.062 5 c 0 1.9771 -0.67 3.6391 -2.062 5.0311 c -2.784 2.785 -7.247 2.785 -10.032 0 c -1.392 -1.4 -2.062 -3.054 -2.062 -5.0311 c 0 -1.977 0.67 -3.608 2.062 -5 c 1.393 -1.392 3.023 -2.063 5 -2.063 z';
	if(prop.shape=="elliptical") shape = "m 19 -19 c -14.689 -5.809 -31.306 1.39 -37.115 16.079 c -2.904 7.344 -2.557 15.171 0.353 21.887 c 6.807 2.692 14.64 2.787 21.887 -0.352 c 14.495 -6.279 21.155 -23.12 14.875 -37.614 z";
	if(prop.shape=="lenticular") shape = "m -20.5 -20.5 c 0 23.19 18.8 41.99 41.99 41.99 c 0 -23.19 -18.8 -41.99 -41.99 -41.99 z";
	if(prop.shape=="totaleclipse") shape = "m "+(-scale)+","+(-scale*2)+" c "+(scale/2)+",0 "+(scale)+","+(scale/2)+" "+(scale)+","+(scale)+" c 0,"+(scale/2)+" "+(-scale/2)+","+(scale)+" "+(-scale)+","+(scale)+" c "+(-scale/2)+",0 "+(-scale)+","+(-scale/2)+" "+(-scale)+","+(-scale)+" c 0,"+(-scale/2)+" "+(scale/2)+","+(-scale)+" "+(scale)+","+(-scale)+" z";
	if(prop.shape=="partialeclipse") shape = "m "+(-scale)+","+(-scale*2)+" c "+(-scale/2)+",0 "+(-scale)+","+(scale/2)+" "+(-scale)+","+(scale)+" c 0,"+(scale/2)+" "+(scale/2)+","+scale+" "+scale+","+scale+" l 0,0 c "+(0.085*scale)+",0 "+(0.17*scale)+","+(-0.012*scale)+" "+(0.25*scale)+","+(-0.031*scale)+" c "+(-scale/4)+",0 "+(-scale/2)+","+(-scale/4)+" "+(-scale/2)+","+(-scale)+" c 0,"+(-scale/2)+" "+(scale/4)+","+(-scale)+" "+(scale/2)+","+(-scale)+" z";
	if(prop.shape=="annulareclipse") shape = "m "+(-scale)+","+(-scale*2)+" c "+(scale/2)+",0 "+(scale)+","+(scale/2)+" "+(scale)+","+(scale)+" c 0,"+(scale/2)+" "+(-scale/2)+","+(scale)+" "+(-scale)+","+(scale)+" c "+(-scale/2)+",0 "+(-scale)+","+(-scale/2)+" "+(-scale)+","+(-scale)+" c 0,"+(-scale/2)+" "+(scale/2)+","+(-scale)+" "+(scale)+","+(-scale)+" m 0,"+(scale/3)+" c "+(-scale/3)+",0 "+(-scale*2/3)+","+(scale/3)+" "+(-scale*2/3)+","+(scale*2/3)+" c 0,"+(scale/3)+" "+(scale/3)+","+(scale*2/3)+" "+(scale*2/3)+","+(scale*2/3)+" c "+(scale/3)+",0 "+(scale*2/3)+","+(-scale/3)+" "+(scale*2/3)+","+(-scale*2/3)+" c 0,"+(-scale/3)+" "+(-scale/3)+","+(-scale*2/3)+" "+(-scale*2/3)+","+(-scale*2/3)+" z";
	if(prop.shape=="hybrideclipse") shape = "m "+(-scale)+","+(-scale*2)+" c "+(scale/2)+",0 "+(scale)+","+(scale/2)+" "+(scale)+","+(scale)+" c 0,"+(scale/2)+" "+(-scale/2)+","+(scale)+" "+(-scale)+","+(scale)+" c "+(-scale/2)+",0 "+(-scale)+","+(-scale/2)+" "+(-scale)+","+(-scale)+" c 0,"+(-scale/2)+" "+(scale/2)+","+(-scale)+" "+(scale)+","+(-scale)+" m 0,"+(scale/3)+" c "+(-scale/3)+",0 "+(-scale*2/3)+","+(scale/3)+" "+(-scale*2/3)+","+(scale*2/3)+" l "+(scale*4/3)+",0  c 0,"+(-scale/3)+" "+(-scale/3)+","+(-scale*2/3)+" "+(-scale*2/3)+","+(-scale*2/3)+" z";

	if(shape){
		var bits = shape.split(/[ \,]/);
		for(var i = 0 ; i < bits.length; i++){
			if(bits[i]!="m" && bits[i]!="c" && bits[i]!="z" && bits[i]!="l" && bits[i]!="a") bits[i] = (parseFloat(bits[i])*s/scale).toFixed(3);
		}
		if(typeof x!=="number") x = 0;
		if(typeof y!=="number") y = 0;
		prop.path = "M"+(x).toFixed(3)+','+(y).toFixed(3)+bits.join(' ');
		if(!attr) attr = {};
		attr.fill = prop.colour;
		attr.stroke = 0;
		if(!attr.title) attr.title = "";
		prop.obj = pp.path(prop.path).attr(attr);
	}else{
		prop.path = "";
	}

	return prop;
}


function drawSpiral(x,y,s,t){

	var spiral = [];
	if(t=="barred") spiral = ["m 3.4862,1.879 c 1.4643,-1.46397,1.4637,-3.8396,-0.028,-5.3315 c 0,0,-0.3535,-0.3535,-0.7071,0 c -0.3535,0.3536,0,0.7071,0,0.7071 c 1.0676,1.0678,0.8991,2.90524,-0.042,3.8468 c -0.1775,0.1773,-0.323,0.3228,-0.5932,0.4233 c 0.1,-1.14974,-0.1162,-1.66025,-1.0919,-2.6364 c -1.48512,-1.4849,-3.0384,-2.2561,-4.5022,-0.7919 c -1.4635,1.46388,-1.4425,3.8608,0.042,5.3459 c 0,0,0.3537,0.3535,0.7072,-0.0001 c 0.3537,-0.3537,0.01,-0.7,0,-0.7071 c -1.0609,-1.0611,-0.9033,-2.9298,0.028,-3.8613 c 0.1853,-0.1853,0.3607,-0.3607,0.6152,-0.4455 c -0.1656,1.40339,0.2507,1.80786,1.178,2.7351 c 1.51403,1.514,2.93,2.1796,4.394,0.7154 z"];
	else if(t=="interacting") spiral = ["m 1,4.5 c 3.105,-1.094,2.799,-3.661,2.543,-4.638 c -0.611,-1.851,-1.721,-2.219,-0.933,-0.525 c 0.559,1.996,-0.354,2.461,-0.615,2.742 c -0.171,-0.778,-0.513,-1.055,-1.327,-1.24 c -0.9911,-0.256,-1.8597,0.3591,-2.1107,1.336 c -0.48,1.8473,1.1742,2.5603,2.4425,2.3253 z", "m -1,-4.6255 c -3.1051,1.0941,-2.7991,3.6606,-2.5434,4.6382 c 0.6112,1.8508,1.7213,2.2187,0.9337,0.5247 c -0.5595,-1.9957,0.3537,-2.4606,0.6146,-2.7416 c 0.1708,0.7777,0.5131,1.055,1.3269,1.2399 c 0.9911,0.256,1.86,-0.3591,2.1106,-1.336 c 0.4805,-1.8471,-1.1741,-2.56,-2.4424,-2.3252 z"];
	else spiral = ["m 3.4862,1.879 c 1.4643,-1.46397,1.4637,-3.8396,-0.028,-5.3315 c 0,0,-0.3535,-0.3535,-0.7071,0 c -0.3535,0.3536,0,0.7071,0,0.7071 c 1.0676,1.0678,0.8991,2.90524,-0.042,3.8468 c -0.1775,0.1773,-0.323,0.3228,-0.5932,0.4233 c 0.7562,-1.02474,0.7275,-2.41025,-0.2482,-3.3863 c -1.48507,-1.4849,-3.8821,-1.5062,-5.3459,-0.042 c -1.4635,1.46388,-1.4425,3.8608,0.042,5.3459 c 0,0,0.3537,0.3535,0.7072,-0.0001 c 0.3537,-0.3537,0.01,-0.7,0,-0.7071 c -1.0609,-1.0611,-0.9033,-2.9298,0.028,-3.8613 c 0.1853,-0.1853,0.3607,-0.3607,0.6152,-0.4455 c -0.7593,1.02839,-0.6868,2.49536,0.2405,3.4225 c 1.51403,1.514,3.8675,1.4922,5.3315,0.028 z m -2.344,-0.753 c -0.61402,0.6281,-1.60808,0.6901,-2.2805,0.018 c -0.6723,-0.67231,-0.6893,-1.72885,-0.06,-2.3581 c 0.63786,-0.6378,1.72185,-0.5764,2.3581,0.06 c 0.6505,0.6505,0.5966,1.65215,-0.018,2.2803 z"];
	var path = "";
	var bits;
	for(var g = 0; g < spiral.length ; g++){
		bits = spiral[g].split(/[ \,]/);
		for(var i = 0 ; i < bits.length; i++){
			if(bits[i]!="m" && bits[i]!="c" && bits[i]!="z") bits[i] = (parseFloat(bits[i])*s/4.57).toFixed(3);
		}
		path = path+"M"+(x).toFixed(4)+','+(y).toFixed(4)+bits.join(' ');
	}
	return path;
}

// avm code
// x position
// y position
// s size
// attr attributes
function drawObject(avm,x,y,s,attr,p){

	// Use Mark's icons
	return getObjectPath(avm,x+s,y+s,s,(p ? p : paper),attr)
}


